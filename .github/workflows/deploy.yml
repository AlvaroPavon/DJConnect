name: Deploy to VPS

on:
  push:
    branches: [ "main" ] # O "master", seg√∫n como se llame tu rama principal

jobs:
  # 1. Integraci√≥n: Verificar que el c√≥digo no est√° roto
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18' # O la versi√≥n que uses en el VPS

    - name: Install dependencies
      run: npm ci

    # Nota: Tu package.json actual tiene un script de test que da error.
    # He comentado esto para que no falle el deploy, pero deber√≠as arreglarlo en el futuro.
    # - name: Run Tests
    #   run: npm test

  # 2. Despliegue: Conectar al VPS y actualizar
  deploy:
    needs: build-and-test # Solo se ejecuta si el paso anterior funciona
    runs-on: ubuntu-latest

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Entrar al directorio del proyecto
          cd /var/www/DJConnect

          # 1. Descargar cambios
          echo "‚¨áÔ∏è Descargando cambios..."
          git pull origin main

          # 2. Instalar dependencias nuevas si las hay
          echo "üì¶ Instalando dependencias..."
          npm install --production

          # 3. Ejecutar script de versionado para evitar cach√© (CR√çTICO para tu app)
          # Usamos la versi√≥n que tienes en el repo
          echo "üîÑ Actualizando versiones de JS..."
          bash add-version-to-js.sh

          # 4. Actualizar configuraci√≥n de Nginx si hubo cambios (Opcional pero seguro)
          if [ -f "nginx-dj-app-secure.conf" ]; then
              echo "üîí Verificando configuraci√≥n Nginx..."
              # Solo copiamos si realmente queremos automatizar esto, con cuidado
              # cp nginx-dj-app-secure.conf /etc/nginx/sites-available/dj-app.conf
              # sudo systemctl reload nginx
          fi
          
          # 5. Reiniciar la aplicaci√≥n con PM2
          echo "üöÄ Reiniciando servidor..."
          pm2 restart dj-app
          
          echo "‚úÖ Despliegue completado exitosamente"