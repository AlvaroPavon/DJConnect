<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pide tu Canción</title>
    <link rel="stylesheet" href="/css/style.css">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>¡Pide tu Canción!</h1>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Busca por título o artista...">
            <ul id="suggestions"></ul>
        </div>
    </div>
    <div id="rating-modal" style="display:none;">
        <div class="modal-content">
            <h3>¿Qué tal lo está haciendo el DJ?</h3>
            <div class="stars">
                <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
            </div>
            <button id="close-modal">Cerrar</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const serverUrl = "https://djapp.duckdns.org";
            const socket = io(serverUrl, { transports: ["websocket"] });
            const searchInput = document.getElementById('search-input');
            const suggestionsList = document.getElementById('suggestions');
            const ratingModal = document.getElementById('rating-modal');
            const urlParams = new URLSearchParams(window.location.search);
            const salaId = urlParams.get('dj');
            const stars = document.querySelectorAll('.stars span');

            // --- LÓGICA MODIFICADA ---
            // Si no hay ID de sala en la URL, redirige al login.
            if (!salaId) {
                window.location.href = '/login.html';
                return; // Detiene la ejecución del resto del script
            }

            // --- LÓGICA DE BÚSQUEDA ---
            let searchTimeout;
            searchInput.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value;
                if (query.length < 3) {
                    suggestionsList.innerHTML = ''; return;
                }
                searchTimeout = setTimeout(async () => {
                    const response = await fetch(`${serverUrl}/search?q=${encodeURIComponent(query)}`);
                    const songs = await response.json();
                    suggestionsList.innerHTML = '';
                    songs.forEach(song => {
                        const item = document.createElement('li');
                        item.dataset.titulo = song.titulo;
                        item.dataset.artista = song.artista;
                        item.textContent = `${song.titulo} - ${song.artista}`;
                        suggestionsList.appendChild(item);
                    });
                }, 300);
            });

            // --- LÓGICA DE CLIC EN SUGERENCIA ---
            suggestionsList.addEventListener('click', (event) => {
                const listItem = event.target.closest('li');
                if (listItem) {
                    const song = {
                        titulo: listItem.dataset.titulo,
                        artista: listItem.dataset.artista
                    };
                    selectSong(song);
                }
            });

            function selectSong(song) {
                socket.emit('nueva-cancion', { salaId: salaId, titulo: song.titulo, artista: song.artista });
                searchInput.value = '';
                suggestionsList.innerHTML = '';
                ratingModal.style.display = 'flex';
            }

            // --- LÓGICA DE VALORACIÓN ---
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = star.getAttribute('data-value');
                    socket.emit('submit-rating', { partyId: salaId, rating: Number(rating) });
                    alert(`¡Gracias por tu puntuación de ${rating} estrellas!`);
                    ratingModal.style.display = 'none';
                });
            });

            document.getElementById('close-modal').addEventListener('click', () => {
                ratingModal.style.display = 'none';
            });
        });
    </script>
</body>
</html>
